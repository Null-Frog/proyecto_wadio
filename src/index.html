<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wadio!</title>

    <!-- Styles -->
    <link rel="stylesheet" href="../css/styles.css">

</head>

<body>
    <header>
        <p>
            Aplicación NO OFICIAL de WhatsApp y sin ánimo de lucro
        </p>
    </header>

    <section>
        <h1>Bienvenido a Wadio!</h1>

        <div id="info">
            <p>
                Para iniciar la aplicación:
            </p>
            <ul>
                <li><span>Introduce la frase de contestación al audio</span></li>
                <li><span>Haz click en "Generar QR" y espera unos segundos</span></li>
                <li><span>Escanéalo con Whatsapp Web</span></li>
                <li><span id="rojo">(!)</span><span> Si esperas demasiado sin escanear, el código caducará y tendrás que volver a iniciar la aplicación</span></li>
            </ul>
        </div>

        <div id="fraseDiv">
            <!-- Div que contendrá un input para que el usuario escriba su frase y un botón para aplicarla -->
            <input type="text" name="frase" id="frase" placeholder="No me mandéis audios, por favor">
            <button id="botonAplicar">Aplicar</button>
            <button id="botonReset">Reset</button>
            <span id="message"></span>
        </div>

        <div class="codQR">
            <a id="linkQR" href="#"><span>Generar QR</span></a>
            <span id="qrData"></span>
        </div>

    </section>

    <footer>
        <p>
            <a href="https://github.com/Null-Frog">Null Frog Github</a> / nullfrogteam@gmail.com
        </p>
    </footer>

    <!-- Inter-process communication -->
    <script>
        const electron = require('electron');
        const ipcRenderer = electron.ipcRenderer;

        var frase = "No me mandéis audios, por favor";
        /**
        * Botón para aplicar la frase de respuesta
        */
        document.getElementById('botonAplicar').onclick = function () {
            var item = document.getElementById("botonAplicar");
            var inputFrase = document.getElementById("frase");

            item.classList.add("botonAplicado");
            item.innerText = "Aplicada";

            if (inputFrase != "") {
                frase = inputFrase.value;
                ipcRenderer.sendSync('synMessage', frase);
            }
        };

        /**
        * Botón para resetear la frase de respuesta
        */
        document.getElementById('botonReset').onclick = function () {
            var item = document.getElementById("botonAplicar");
            var inputFrase = document.getElementById("frase");

            item.classList.remove("botonAplicado");
            item.innerText = "Aplicar";
            frase = "No me mandéis audios, por favor";
            inputFrase.value = "";
            ipcRenderer.sendSync('synMessage', frase);
        };

        document.getElementById("frase").onfocus = function () {
            var item = document.getElementById("botonAplicar");

            item.classList.remove("botonAplicado");
            item.innerText = "Aplicar";
        };

        /**
        * Iniciando cliente
        */
        document.getElementById("linkQR").onclick = function () {
            ipcRenderer.sendSync('synActivar', "activar");
        }

        ipcRenderer.on('elQR', (event, data) => {
            document.getElementById('linkQR').innerHTML = "¡Generado!";
            chorroQR = data;
            generateQR(chorroQR);
            
            

            const getImg = () => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        resolve(elem)
                    }, 3000);
                })
            }
            
            async function fetching() {
                try {
                    const fetched = await getImg();
                    elem.src = await '../qrImage.png';
                    await document.getElementById('qrData').appendChild(fetched);
                } catch (error) {
                    console.log(error);
                }
            }
            fetching();
            
        });
            
        var chorroQR;
        var qrCode = require('qrcode');
        var elem = document.createElement("img");
        
        const generateQR = chorroQR => {
            
            try {
                qrCode.toFile('./qrImage.png', chorroQR);
            } catch (err) {
                console.error(err)
            }
        }
    </script>
</body>

</html>